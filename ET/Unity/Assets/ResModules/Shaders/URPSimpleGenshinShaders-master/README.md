# Overview
A Unity URP shader for Genshin Impact style character facial shading.

### Key Features ###
 - Supports Genshin facial shadow gradient texture
    - All angles
    - Adjustable light direction offset
    - Shadow color
    
 - Outlines with configurable thickness, color, offset

 ### Limitations that probably need to be fixed ###
 - Only supports one directional light

 - Does not receive external shadows

 - Unnatural shadow color when main light intensity > 1

 [Demo Video (Bilibili)](https://www.bilibili.com/video/BV15t4y1V76U)
 
 <img src="https://i.ibb.co/DfHh14Y/thumbnail1-l-JPG.png" width="50%">
 
 ### Usage (URP) ###

Facial shadow gradient textures for Genshin Impact character models can be found under `./Textures/`.

 1. Prepare facial shadow gradient texture. Disable *sRGB (Color Texture)* or set Texture Type to *Directional Lightmap*.

 2. Assign shader `SimpleGenshinFacial` to face material. (reset material to get pre-configured settings)

 3. Assign facial shadow gradient texture to the `_LightMap` field, and enable `_UseLightMap`.

### FAQ ###

- Shadows are blurry - For smooth shadow edges, set shadow gradient texture's compression quality to high.

- Shadow coverage doesn't change based on the head facing - The shader might not be reading the correct object direction. Try setting the character's head bone as the character head mesh's skinned mesh root. Alternatively, you could modify the shader to use a direction that can be updated by script.

- Recommended material property settings - You can get preconfigured outline, shadow color, emission color settings on material reset (click the three vertical dots on the top right corner in the material inspector).

## How It Works ##

Genshin Impact's facial shadow texture stores shadow coverage information for left-side lighting at angles 0° ~ 180° on the xz plane. All we have to do is take the shadow texture, flip it if light is coming from the right, and compare its colour value with `FdotL` (i.e. forward xz direction • light xz direction) to apply the correct shadow coverage.

Since `FdotL` is in the range [-1,1], we map it to [0,1] to match lightmap value range.

```glsl
float LightMap = RdotL > 0 ? surfaceData._lightMapR.r : surfaceData._lightMapL.r;
float litOrShadow = step((-FdotL + 1) / 2, LightMap);
```

## Environment ##
Tested in Unity 2022.2.1f1, URP14.0.4
 
---
### Based on URP toon shader example by ColinLeung-NiloCat. ###

# Unity URP Simplified Toon Lit Shader Example (for you to learn writing custom lit shader in URP)

This repository is NOT the full version shader, the full version shader is still WIP and not yet released.
This repository is only for tutorial purpose, which only contains a very simple and short shader example.

Screenshots from the Full version shader (not yet released):
-------------------
shader ON
![screenshot](https://i.imgur.com/xJSzAMZ.png)
shader OFF
![screenshot](https://i.imgur.com/xqMkSKe.png)
shader ON
![screenshot](https://i.imgur.com/KGvkY3m.png)
shader OFF
![screenshot](https://i.imgur.com/0JiRa7k.png)

SHADER ON
![screenshot](https://i.imgur.com/utXF8Qq.png)
![screenshot](https://i.imgur.com/oEsHSMM.png)
BEFORE
![screenshot](https://i.imgur.com/K6mZCcH.png)
AFTER:
![screenshot](https://i.imgur.com/hjEeAoM.png)
see it in motion-> https://youtu.be/D9ocVzGJfI8

---
3D enviroment model TEST  
![screenshot](https://i.imgur.com/AOAxQJ8.png)
![screenshot](https://i.imgur.com/WlOQtCf.png)
see it in motion-> https://youtu.be/GcW0pNo-zus
---
湊 あくあ（みなと あくあ，Minato Aqua） model TEST
![screenshot](https://i.imgur.com/iDDFjoO.png)
![screenshot](https://i.imgur.com/4aFqOND.png)
![screenshot](https://i.imgur.com/7KjUwrI.png)
see it in motion-> https://youtu.be/7zICgzdxuGg
---
see it in motion-> https://youtu.be/X3XoYMTleJ0
---

Kawaii model TEST (@ganbaru_sisters)
![screenshot](https://i.imgur.com/7CAw71u.png)
![screenshot](https://i.imgur.com/42CUENh.png)

Upgraded to Unity2020.2 (URP 10.2.1)
SHADER ON
![screenshot](https://i.imgur.com/6chTRCl.png)
SHADER OFF
![screenshot](https://i.imgur.com/Vu2M5zB.png)
HD
![screenshot](https://i.imgur.com/KXYYfaN.png)

shader ON
![screenshot](https://i.imgur.com/A2NA1Po.png)
shader OFF
![screenshot](https://i.imgur.com/t9OqASe.png)
shader ON
![screenshot](https://i.imgur.com/VLZKP5h.png)
shader OFF
![screenshot](https://i.imgur.com/lTm0zvH.png)

---

BEFORE
![screenshot](https://i.imgur.com/JImt9l4.png)
AFTER
![screenshot](https://i.imgur.com/0oc1hFK.png)
see it in motion-> https://youtu.be/KpRkxPnHuK0
---
BEFORE
![screenshot](https://i.imgur.com/Ak6rFTp.png)
AFTER
![screenshot](https://i.imgur.com/6BTsiRF.png)
(more shadow from trees)
![screenshot](https://i.imgur.com/qSygREh.png)
---

BEFORE
![screenshot](https://i.imgur.com/rXEDmiy.png)
AFTER:
![screenshot](https://i.imgur.com/J7F3vuC.png)
see it in motion-> https://youtu.be/hUWacEQH6js
---
BEFORE

![screenshot](https://i.imgur.com/kZFNunW.png)

AFTER:

![screenshot](https://i.imgur.com/mnm5uYS.png)

BEFORE


![screenshot](https://i.imgur.com/a9VUVgd.png)


AFTER:


![screenshot](https://i.imgur.com/VgSZMka.png)


add 2D hair shadow & rim light


![screenshot](https://i.imgur.com/KXdMhhv.png)




see it in motion-> https://youtu.be/S67GlGAnvWA
---

---
BEFORE
![screenshot](https://i.imgur.com/ApJyl6p.png)
AFTER:
![screenshot](https://i.imgur.com/5GiKMUG.png)

see it in motion-> https://youtu.be/M6FKoEiOAzU
---
-------------------
BEFORE
![screenshot](https://i.imgur.com/FiuK1Cj.png)
AFTER:
Sunny + StreetLight ON
![screenshot](https://i.imgur.com/Lh5D9Y9.png)
Sunny + StreetLight OFF
![screenshot](https://i.imgur.com/NcsKQL8.png)
Night + StreetLight ON
![screenshot](https://i.imgur.com/AXV9Yig.png)
Night + StreetLight OFF
![screenshot](https://i.imgur.com/mJ1sjUm.png)
see it in motion -> https://youtu.be/jDSnJmZrKPw
---
BEFORE
![screenshot](https://i.imgur.com/U5ba2lM.png)
AFTER
![screenshot](https://i.imgur.com/cuZUqwW.png)
---
BEFORE
![screenshot](https://i.imgur.com/AMDcMdG.png)
AFTER
![screenshot](https://i.imgur.com/GB31Nay.png)
see it in motion -> https://youtu.be/ZfSZOHTBypc
---
BEFORE
![screenshot](https://i.imgur.com/UCETVsr.png)
AFTER
![screenshot](https://i.imgur.com/7Wjdp8W.png)
see it in motion -> https://youtu.be/EgxiWPk-vaE

---
BEFORE
![screenshot](https://i.imgur.com/5afc5z5.png)
AFTER
![screenshot](https://i.imgur.com/pQ4DIqe.png)
see it in motion -> https://youtu.be/Ty4DXLFqqDo
---
BEFORE
![screenshot](https://i.imgur.com/WKL3NwV.png)
AFTER
![screenshot](https://i.imgur.com/8e6wtVZ.png)
see it in motion -> https://youtu.be/cebGl_MaWnI
---
BEFORE
![screenshot](https://i.imgur.com/KwpjGHz.png)
AFTER
![screenshot](https://i.imgur.com/KPxL4vR.png)
see it in motion ->https://youtu.be/nl5z0r8a9vk
---
![screenshot](https://i.imgur.com/KxdjhCx.png)
![screenshot](https://i.imgur.com/6t2FMcg.png)
![screenshot](https://i.imgur.com/CZHnfMC.png)
see it in motion -> https://youtu.be/uVI_QOioER4
---
Fake Skin SSS & specular
![screenshot](https://i.imgur.com/ZoDO5TB.png)
![screenshot](https://i.imgur.com/ICH4dFt.png)

BEFORE
![screenshot](https://i.imgur.com/dPvjIQK.png)
AFTER
![screenshot](https://i.imgur.com/GvxXtva.png)





What is included in this "simplified version" toon lit shader repository?
-------------------
This repository contains a very simple toon lit shader example, to help people writing their first custom toon lit shader in URP.

This example shader's default result(without editing material params) = the following picture
![screenshot](https://i.imgur.com/mbUnvsA.png)

Because this example toon lit shader aims to help people learning shader writing in URP, it is an extremely simplified version of the full version one. This repository only contains ~10% of the full version shader, which only contains the most useful & easy to understand sections, to make sure everyone can understand the shader code easily.

It is actually a "How to write your first custom lit shader in URP" example, instead of a good looking toon lit shader example (lots of toon lit tricks are not included in this example shader, for tutorial reason).

Why creating this "simplified version" toon lit shader?
-------------------
Lots of my shader friends are looking for a toon lit example shader in URP (not Shader Graph), I want them to switch to URP with me (instead of still staying in built-in RP), so I decided to provide a simple enough URP toon lit shader example. 

How to try this simplified toon lit example shader in my URP project?
-------------------
1. Clone all .shader & .hlsl files into your URP project.
2. Put these files inside the same folder.
3. Change your character's material's shader to "SimpleURPToonLitExample(With Outline)"
4. make sure atleast _BaseMap(albedo) is assigned
5. setup DONE, you can now test your character with light probe/directional light/point light/spot light
6. edit the material properties to see how the render result changes
7. Most important: open these shader files, spend some time reading it, you will understand how to write custom lit shader in URP very quickly
8. Most important: open "SimpleURPToonLitOutlineExample_LightingEquation.hlsl", edit it, experiment with your own toon lighting equation ideas, which is the key part of toon lit shader!

I see the shader is working now, but the outline is broken?
-------------------
For this tutorial shader, you can let Unity to calculate smooth normal for you, which can produce better outline, 
but doing this will make lighting slightly incorrect.

1. click you character's .fbx
2. In the model tab
3. edit "Normals" to Calculate
4. edit "Smoothing Angle" to 180  
  
![screenshot](https://i.imgur.com/yxDkeGP.png)  
before calculate smooth normal (printscreen of tutorial shader, not full version)  
![screenshot](https://i.imgur.com/uTJ3gxB.png)  
after calculate smooth normal  (printscreen of tutorial shader, not full version)
![screenshot](https://i.imgur.com/9Jnnigf.png)

*The full version shader project will contains a few editor C# script, which can help the shader to produce correct lighting and perfect outline together.

What is NOT included in this simplified example shader?
-------------------
For simplicity reason, I removed most of the features from the Full version shader (deleted 90% of the original shader), else this example shader will be way too complex for reading & learning. The removed features are:
- face anime lighting (auto fix face ugly lighting due to vertex normal without modify fbx, very important)
- smooth outline normal auto baking (fix ugly outlines without modify fbx, very important)
- auto 2D hair shadow on face (very important, it is very difficult to produce good looking shadow result using shadowmap)
- sharp const width rim light (Blue Protocol / Genshin Impact)
- tricks to render eye/eyebrow over hair
- hair "angel ring" reflection
- PBR specular lighting (GGX)
- HSV control shadow & outline color
- 2D mouth renderer
- almost all the extra texture input options like roughness, specular, normal map...
- LOTS of sliders to control lighting, final color & outline
- ***just too much for me to write all removed feature here, the full version shader is a totally different level product

When will the Full version toon lit shader release?
-------------------
We don't have ETA now, we are still working on it, here are some videos about the Full version toon lit shader:
- https://youtu.be/hUWacEQH6js
- https://www.youtube.com/channel/UCsvlGOZyqjd68ZUUmgqwj0g

How to get a test character model?
-------------------
The easiest way to get a character model is by downloading Unity-Chan in the assetstore.

Also, here are some websites that can download models(If the creator allows it)
- https://3d.nicovideo.jp/
- https://hub.vroid.com/

if you downloaded a .pmx file, use MMD4Mecanim to convert it to .fbx & prefab directly inside unity
http://stereoarts.jp/

if you downloaded a .vrm file, use UniVRM to convert it to .fbx & prefab directly inside unity
https://github.com/vrm-c/UniVRM

Editor environment requirement
-----------------------
- URP 10.2.1
- Unity 2020.2

---------------------------
Apply our shader to another model (2020-2 early version screen shots)
https://youtu.be/uVI_QOioER4

![screenshot](https://i.imgur.com/LBTNZCH.png)
![screenshot](https://i.imgur.com/X6hAD7W.png)
![screenshot](https://i.imgur.com/WIGyMVx.png)
![screenshot](https://i.imgur.com/zou7PxL.png)
![screenshot](https://i.imgur.com/WpkJyFB.png)
![screenshot](https://i.imgur.com/3iyu3eG.png)

More old screenshots from the Full version shader(not yet released):
---
![screenshot](https://i.imgur.com/RDqMYVP.png)
![screenshot](https://i.imgur.com/AqqXbjz.png)
![screenshot](https://i.imgur.com/m95orpw.png)
![screenshot](https://i.imgur.com/1uU9Dp1.png)
![screenshot](https://i.imgur.com/U2XYPAj.png)
![screenshot](https://i.imgur.com/23eeHZS.png)
![screenshot](https://i.imgur.com/pMCxwyP.png)
![screenshot](https://i.imgur.com/sxeUg1K.png)
https://youtu.be/tNnqIP4NdV8
---

![screenshot](https://i.imgur.com/DDr32Mu.png)
https://youtu.be/IP293mAmBCk

![screenshot](https://i.imgur.com/kbpw4Me.png)
![screenshot](https://i.imgur.com/jaMaTKt.png)
![screenshot](https://i.imgur.com/D7ARBo0.png)

![screenshot](https://i.imgur.com/lt45arW.png)
![screenshot](https://i.imgur.com/RcSz8H1.png)

different Background image TEST
![screenshot](https://i.imgur.com/hev9PtZ.png)
![screenshot](https://i.imgur.com/lRdXn3I.png)
![screenshot](https://i.imgur.com/cx8tZox.png)
![screenshot](https://i.imgur.com/GYPoNWT.png)
![screenshot](https://i.imgur.com/fZw0Wzt.png)

credits
------------------------
model's creator in shader demo image/video: 
- https://i-fox.club/pcr/
- https://sketchfab.com/3d-models/band-of-sisters-2f1c0626d4cf4fd286c4cf5d109f7a32
- miHoYo - Honkai Impact 3
- Kuro Game - Punishing: Grey Raven
- Azur Lane: Crosswave
- Sour式鏡音リン
- Unity-Chan
- https://www.bilibili.com/blackboard/activity-mrfzrlha.html
- 【オリジナル3Dモデル】Eve -イヴ- by ganbaru_sisters https://booth.pm/en/items/2557029 
- https://www.mmd.hololive.tv/
- Japanese Street by Art Equilibrium https://assetstore.unity.com/packages/3d/environments/urban/japanese-street-170162


