//功能：登陆注册业务系统
using PEProtocol;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

namespace DarkGod.Main
{
    public class LoginSys : SystemRoot<LoginSys>
    {
        public static LoginSys Instance = null;

        public LoginWnd loginWnd;
        public CreateWnd createWnd;

        protected override void Awake()
        {
            base.Awake();

            GameRoot.MainInstance.OnGameEnter += InitSys;
        }

        public override void InitSys()
        {
            base.InitSys();

            Instance = MainInstance;
            PECommon.Log("Init LoginSys...");
        }

        /// <summary>
        /// 进入登录场景
        /// </summary>
        public void EnterLogin()
        {
            //异步的加载登录场景
            //并显示加载的进度
            resSvc.AsyncLoadScene(Constants.ResourcePackgeName, PathDefine.SceneLogin, () =>
            {
                //加载完成以后再打开注册登录界面
                loginWnd.SetWndState();
                List<string> auLst = new List<string> { Constants.BGLogin };
                audioSvc.StopBGMusic();
                audioSvc.PlayBGMusics(auLst, 3f);
            });
            GameRoot.MainInstance.SetGameState(GameState.Login);
        }

        public void RspLogin(GameMsg msg)
        {
            MsgBox.MainInstance.ShowMessageBox("登录成功");
            GameRoot.MainInstance.SetPlayerData(msg.rspLogin);

            if (msg.rspLogin.playerData.name == "")
            {
                //打开角色创建界面
                createWnd.SetWndState();
            }
            else
            {
                //进入主城
                MainCitySys.Instance.EnterMainCity();
            }
            //关闭登录界面
            loginWnd.SetWndState(false);
        }

        public void RspRename(GameMsg msg)
        {
            GameRoot.MainInstance.SetPlayerName(msg.rspRename.name);

            //跳转场景进入主城
            //打开主城的界面
            MainCitySys.Instance.EnterMainCity();

            //关闭创建界面
            createWnd.SetWndState(false);
        }

        private void OnDestroy()
        {
            GameRoot.MainInstance.OnGameEnter -= InitSys;
        }
    }
}
